{
  name: "Amdocs Invoice Bronze Load"

  transformations: {

    set_dynamic_parts: {
      source: hive
      materialize: transact
      sql: "set hive.exec.dynamic.partition.mode=nonstrict"
    }

    DF_BILL_INVOICE_BRONZE: {
      source: jdbc
      jdbc: {
        url: "jdbc:postgresql://10.4.47.58:5432/cust1"
        user: "dbguest"
        password: "dbguest"
        is_dbtable: n
      }
      dependsOn: [set_dynamic_parts]
      materialize: table
      targetName: "bss_billing_payment.bill_invoice_bronze"
      mode: overwrite
      format: hive
      sql: """
        SELECT
            account_no,
            bill_ref_no,
            bill_ref_resets,
            bill_sequence_num,
            process_num,
            prev_bill_refno,
            prev_bill_ref_resets,
            prev_balance_refno,
            prev_balance_ref_resets,
            zip,
            from_date,
            to_date,
            next_to_date,
            prep_date,
            tax_date,
            statement_date,
            payment_due_date,
            prev_ppdd,
            prev_cutoff_date,
            bill_period,
            currency_code,
            pay_method,
            bill_disp_meth,
            tax_journal_status,
            account_status,
            image_req,
            image_done,
            special_code,
            prep_task,
            prep_status,
            format_status,
            dispatch_count,
            dispatch_date,
            file_name,
            start_offset,
            end_offset,
            page_count,
            bill_hold_code,
            prep_error_code,
            format_error_code,
            CURRENT_TIMESTAMP AS ingest_time,
            CAST(TO_CHAR(prep_date, 'YYYYMMDD') AS INTEGER) AS time_id
        FROM arbor.bill_invoice
      """
    }

    DF_BILL_INVOICE_DETAIL_BRONZE: {
      source: jdbc
      jdbc: {
        url: "jdbc:postgresql://10.4.47.58:5432/cust1"
        user: "dbguest"
        password: "dbguest"
        is_dbtable: n
      }
      materialize: table
      targetName: "bss_billing_payment.bill_invoice_detail_bronze"
      mode: overwrite
      format: hive
      sql: """
            SELECT bill_ref_no, bill_ref_resets, process_num, bill_invoice_row, package_id, component_id, type_code,
                subtype_code, tracking_id, tracking_id_serv, tracking_date, prep_sequence, prorate_code, billing_level,
                billing_category, amount, rated_amount, secondary_amount, rate_currency_code, units, tax, tax_rate,
                tax_pkg_inst_id, discount, discount_id, trans_date, provider_id, element_id, product_line_id, description_code,
                rate_type, rate_period, subscr_no, subscr_no_resets, equip_status, from_date, to_date, annotation, profile_id,
                geocode, aux_tax_info, federal_tax, state_tax, county_tax, city_tax, other_tax, test_flag, arch_flag,
                rev_rcv_cost_ctr, b_rev_rcv_cost_ctr, aggr_usage_id, tax_type_code, open_item_id, amount_reduction,
                amount_reduction_id, zone_class, bill_class, inclusive_tax, pcm_active_dt, misc_number1, misc_number2,
                lob_id, tenant_id, CURRENT_TIMESTAMP AS ingest_time
            FROM arbor.bill_invoice_detail
      """
    }


    DF_CMF_BALANCE_TMP: {
      source: jdbc
      jdbc: {
        url: "jdbc:postgresql://10.4.47.58:5432/cust1"
        user: "dbguest"
        password: "dbguest"
        is_dbtable: n
      }
      materialize: table
      targetName: "bss_billing_payment.cmf_balance_tmp"
      mode: overwrite
      format: hive
      sql: """
            SELECT account_no, currency_code, bill_ref_no, bill_ref_resets, ppdd_date, 
              orig_ppdd_date, closed_date, new_charges, net_new_charges, total_due, total_adj, 
              total_paid, balance_due, dispute_amt, late_exempt_charges, collection_indicator, 
              chg_date, chg_who, gl_amount, converted, new_charge_credits, tenant_id
            FROM arbor.cmf_balance
      """
    }

    P_MAX_CHG_DATE_CMF_BALANCE: {
      source: hive
      dependsOn: [DF_CMF_BALANCE_TMP]
      materialize: value
      sql: """
        SELECT 
          CASE 
            WHEN COUNT(*) = 0 THEN '1970-01-01 00:00:00'
            ELSE max(chg_date) 
          END as max_chg_date 
        FROM bss_billing_payment.cmf_balance_bronze
      """
      mapping: {
        max_chg_date.map: max_chg_date
      }
    }

    DF_CMF_BALANCE_BRONZE: {
      source: hive
      dependsOn: [DF_CMF_BALANCE_TMP, P_MAX_CHG_DATE_CMF_BALANCE]
      materialize: table
      targetName: "bss_billing_payment.cmf_balance_bronze"
      mode: append
      format: iceberg
      sql: """
            SELECT account_no, currency_code, bill_ref_no, bill_ref_resets, ppdd_date, 
              orig_ppdd_date, closed_date, new_charges, net_new_charges, total_due, total_adj, 
              total_paid, balance_due, dispute_amt, late_exempt_charges, collection_indicator, 
              chg_date, chg_who, gl_amount, converted, new_charge_credits, tenant_id, 
              CURRENT_TIMESTAMP AS ingest_time
            FROM bss_billing_payment.cmf_balance_tmp
               WHERE chg_date > CAST('<<max_chg_date>>' AS TIMESTAMP)
      """
    }

    DF_CMF_BALANCE_SILVER: {
      source: hive
      dependsOn: [DF_CMF_BALANCE_TMP, DF_CMF_BALANCE_BRONZE]
      materialize: table
      targetName: "bss_billing_payment.cmf_balance_silver"
      mode: overwrite
      format: iceberg
      sql: """
            SELECT account_no, currency_code, bill_ref_no, bill_ref_resets, ppdd_date, 
              orig_ppdd_date, closed_date, new_charges, net_new_charges, total_due, total_adj, 
              total_paid, balance_due, dispute_amt, late_exempt_charges, collection_indicator, 
              chg_date, chg_who, gl_amount, converted, new_charge_credits, tenant_id, 
              CURRENT_TIMESTAMP AS ingest_time
            FROM bss_billing_payment.cmf_balance_tmp
      """
    }

    DF_CMF_BALANCE_DETAIL_TMP: {
      source: jdbc
      jdbc: {
        url: "jdbc:postgresql://10.4.47.58:5432/cust1"
        user: "dbguest"
        password: "dbguest"
        is_dbtable: n
      }
      materialize: table
      targetName: "bss_billing_payment.cmf_balance_detail_tmp"
      mode: overwrite
      format: hive
      sql: """
            SELECT account_no, currency_code, bill_ref_no, bill_ref_resets, ppdd_date, 
                orig_ppdd_date, closed_date, new_charges, net_new_charges, total_due, 
                total_adj, total_paid, balance_due, dispute_amt, late_exempt_charges, 
                collection_indicator, chg_date, chg_who, gl_amount, refinance_tracking_id, 
                refinance_tracking_id_serv, open_item_id, external_id, converted, 
                new_charge_credits, tenant_id
            FROM arbor.cmf_balance_detail
      """
    }

    P_MAX_CHG_DATE_CMF_BALANCE_DETAIL: {
      source: hive
      dependsOn: [DF_CMF_BALANCE_DETAIL_TMP]
      materialize: value
      sql: """
        SELECT 
          CASE 
            WHEN COUNT(*) = 0 THEN '1970-01-01 00:00:00'
            ELSE max(chg_date) 
          END as max_chg_date_detail
        FROM bss_billing_payment.cmf_balance_detail_bronze
      """
      mapping: {
        max_chg_date_detail.map: max_chg_date_detail
      }
    }

    DF_CMF_BALANCE_DETAIL_BRONZE: {
      source: hive
      dependsOn: [DF_CMF_BALANCE_DETAIL_TMP, P_MAX_CHG_DATE_CMF_BALANCE_DETAIL]
      materialize: table
      targetName: "bss_billing_payment.cmf_balance_detail_bronze"
      mode: append
      format: iceberg
      sql: """
            SELECT account_no, currency_code, bill_ref_no, bill_ref_resets, ppdd_date, 
                orig_ppdd_date, closed_date, new_charges, net_new_charges, total_due, 
                total_adj, total_paid, balance_due, dispute_amt, late_exempt_charges, 
                collection_indicator, chg_date, chg_who, gl_amount, refinance_tracking_id, 
                refinance_tracking_id_serv, open_item_id, external_id, converted, 
                new_charge_credits, tenant_id, CURRENT_TIMESTAMP AS ingest_time
            FROM bss_billing_payment.cmf_balance_detail_tmp
               WHERE chg_date > CAST('<<max_chg_date_detail>>' AS TIMESTAMP)
      """
    }

    DF_CMF_BALANCE_DETAIL_SILVER: {
      source: hive
      dependsOn: [DF_CMF_BALANCE_DETAIL_TMP, DF_CMF_BALANCE_DETAIL_BRONZE]
      materialize: table
      targetName: "bss_billing_payment.cmf_balance_detail_silver"
      mode: overwrite
      format: iceberg
      sql: """
            SELECT account_no, currency_code, bill_ref_no, bill_ref_resets, ppdd_date, 
                orig_ppdd_date, closed_date, new_charges, net_new_charges, total_due, 
                total_adj, total_paid, balance_due, dispute_amt, late_exempt_charges, 
                collection_indicator, chg_date, chg_who, gl_amount, refinance_tracking_id, 
                refinance_tracking_id_serv, open_item_id, external_id, converted, 
                new_charge_credits, tenant_id, CURRENT_TIMESTAMP AS ingest_time
            FROM bss_billing_payment.cmf_balance_detail_tmp
      """
    }

    # ********** Dimensional Tables **********

    # Package Definition Values -> Start

    DF_PACKAGE_DEFINITION_VALUES_TMP: {
      source: jdbc
      jdbc: {
        url: "jdbc:postgresql://10.4.47.58:5432/cust1"
        user: "dbguest"
        password: "dbguest"
        is_dbtable: n
      }
      materialize: table
      targetName: "bss_billing_payment.package_definition_values_tmp"
      mode: overwrite
      format: hive
      sql: """
            SELECT package_id, language_code, short_display, display_value, config_tag_id, tenant_id
            FROM arbor.package_definition_values
      """
    }

    DF_PACKAGE_DEFINITION_VALUES_DIM: {
      source: hive
      dependsOn: [DF_PACKAGE_DEFINITION_VALUES_TMP]
      materialize: transact
      sql: """
            MERGE INTO bss_billing_payment.dim_package_definition_values USING bss_billing_payment.package_definition_values_tmp AS pkg_tmp
            ON bss_billing_payment.dim_package_definition_values.package_id = pkg_tmp.package_id 
            AND bss_billing_payment.dim_package_definition_values.tenant_id = pkg_tmp.tenant_id

            WHEN MATCHED THEN UPDATE SET
                language_code = pkg_tmp.language_code,
                short_display = pkg_tmp.short_display,
                display_value = pkg_tmp.display_value,
                config_tag_id = pkg_tmp.config_tag_id,
                updated_date = CURRENT_TIMESTAMP

            WHEN NOT MATCHED THEN INSERT (
                package_id,
                language_code,
                short_display,
                display_value,
                config_tag_id,
                tenant_id,
                updated_date
            )
            VALUES (
                pkg_tmp.package_id,
                pkg_tmp.language_code,
                pkg_tmp.short_display,
                pkg_tmp.display_value,
                pkg_tmp.config_tag_id,
                pkg_tmp.tenant_id,
                CURRENT_TIMESTAMP
            )
        """
    }

    # Package Definition Values -> End

    # Bill Preparation Status

    DF_DIM_BILL_PREPARATION_STATUS: {
      source: hive
      materialize: table
      targetName: "bss_billing_payment.dim_bill_preparation_status"
      mode: overwrite
      format: hive
      sql: """
            SELECT * FROM VALUES
                (0, 'Incomplete'),
                (1, 'Done'),
                (2, 'New, no activity'),
                (3, 'Credit card hold'),
                (4, 'Pro-forma'),
                (5, 'Suppressed (low balance)')
      """
  }

  DF_DIM_INVOICE_TYPE_CODE: {
    source: hive
    materialize: table
    targetName: "bss_billing_payment.dim_bill_invoice_detail_type_code"
    mode: overwrite
    format: hive
    sql: """
          SELECT * FROM VALUES
              (1, 'BMF_TRANS_DESCR transaction (payment)'),
              (2, 'PRODUCT_ELEMENTS transaction (recurring charge)'),
              (3, 'NRC_TRANS_DESCR transaction (Non-recurring charge)'),
              (4, 'ADJ_TRANS_DESCR transaction (adjustment)'),
              (5, 'Summary. Depends on minimum_summaries system parameter.'),
              (6, 'UNIT_CR_DEFINITIONS transaction (unit credit)'),
              (7, 'CDR_DATA transaction (usage charge)'),
              (8, 'PREPAYMENT transaction (prepayment)'),
              (9, 'CMF_BONUS_POINT transaction (bonus point)')
      """
  }

  DF_DIM_CURRENCY_CODE: {
    source: jdbc
    jdbc: {
      url: "jdbc:postgresql://10.4.47.58:5432/cust1"
      user: "dbguest"
      password: "dbguest"
      is_dbtable: n
    }
    materialize: table
    targetName: "bss_billing_payment.dim_rate_currency_values"
    mode: overwrite
    format: hive
    sql: """
          SELECT currency_code, language_code, short_display, display_value, 
                 config_tag_id, tenant_id 
          FROM arbor.rate_currency_values
      """
  }

  # ********** Cleanup Transformations for Iceberg Tables **********

  WF_GET_OLDER_THAN_DATE: {
    source: hive
    materialize: value
    sql: """SELECT date_format(date_sub(current_date(), 5), 'yyyy-MM-dd') AS older_than_date"""
    mapping: {
      older_than_date.map: older_than_date
    }
  }

  WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_BRONZE: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_BRONZE, WF_GET_OLDER_THAN_DATE]
    materialize: transact
    sql: """CALL system.expire_snapshots('bss_billing_payment.cmf_balance_bronze', TIMESTAMP '<<older_than_date>>T00:00:00', 2)"""
  }

  WF_REMOVE_ORPHAN_FILES_CMF_BALANCE_BRONZE: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_BRONZE, WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_BRONZE]
    materialize: transact
    sql: """CALL system.remove_orphan_files('bss_billing_payment.cmf_balance_bronze')"""
  }

  WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_SILVER: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_SILVER, WF_GET_OLDER_THAN_DATE]
    materialize: transact
    sql: """CALL system.expire_snapshots('bss_billing_payment.cmf_balance_silver', TIMESTAMP '<<older_than_date>>T00:00:00', 2)"""
  }

  WF_REMOVE_ORPHAN_FILES_CMF_BALANCE_SILVER: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_SILVER, WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_SILVER]
    materialize: transact
    sql: """CALL system.remove_orphan_files('bss_billing_payment.cmf_balance_silver')"""
  }

  WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_DETAIL_BRONZE: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_DETAIL_BRONZE, WF_GET_OLDER_THAN_DATE]
    materialize: transact
    sql: """CALL system.expire_snapshots('bss_billing_payment.cmf_balance_detail_bronze', TIMESTAMP '<<older_than_date>>T00:00:00', 2)"""
  }

  WF_REMOVE_ORPHAN_FILES_CMF_BALANCE_DETAIL_BRONZE: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_DETAIL_BRONZE, WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_DETAIL_BRONZE]
    materialize: transact
    sql: """CALL system.remove_orphan_files('bss_billing_payment.cmf_balance_detail_bronze')"""
  }

  WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_DETAIL_SILVER: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_DETAIL_SILVER, WF_GET_OLDER_THAN_DATE]
    materialize: transact
    sql: """CALL system.expire_snapshots('bss_billing_payment.cmf_balance_detail_silver', TIMESTAMP '<<older_than_date>>T00:00:00', 2)"""
  }

  WF_REMOVE_ORPHAN_FILES_CMF_BALANCE_DETAIL_SILVER: {
    source: hive
    dependsOn: [DF_CMF_BALANCE_DETAIL_SILVER, WF_EXPIRE_SNAPSHOTS_CMF_BALANCE_DETAIL_SILVER]
    materialize: transact
    sql: """CALL system.remove_orphan_files('bss_billing_payment.cmf_balance_detail_silver')"""
  }

  WF_EXPIRE_SNAPSHOTS_DIM_PACKAGE_DEFINITION_VALUES: {
    source: hive
    dependsOn: [DF_PACKAGE_DEFINITION_VALUES_DIM, WF_GET_OLDER_THAN_DATE]
    materialize: transact
    sql: """CALL system.expire_snapshots('bss_billing_payment.dim_package_definition_values', TIMESTAMP '<<older_than_date>>T00:00:00', 2)"""
  }

  WF_REMOVE_ORPHAN_FILES_DIM_PACKAGE_DEFINITION_VALUES: {
    source: hive
    dependsOn: [DF_PACKAGE_DEFINITION_VALUES_DIM, WF_EXPIRE_SNAPSHOTS_DIM_PACKAGE_DEFINITION_VALUES]
    materialize: transact
    sql: """CALL system.remove_orphan_files('bss_billing_payment.dim_package_definition_values')"""
  }

 }
}
